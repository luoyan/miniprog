/*! page - v1.0.0 - 2013-11-20 */
define("js/page/search",["./base","jquery","jqueryplugins","Boxy","myPagination"],function(require,exports,module){function initSearchSource(){setTimeout(function(){source_index==sources.length?$("#search_channel").text("搜索完毕"):($("#search_channel").text(sources[source_index++]),initSearchSource())},500)}function initEvent(){$("#search_btn_2").click(function(){var a=$("#search_text_2").val();if(""!=$.trim(a))return MM.strlen(a)>36?(alert("您搜索的关键词过长，请缩短到18个汉字或者36英文字符以内"),void 0):(location.href="/search?q="+a,void 0)}),$("#search_text_2").keydown(function(a){if(13==a.keyCode){var b=$("#search_text_2").val();if(""==$.trim(b))return;if(MM.strlen(b)>36)return alert("您搜索的关键词过长，请缩短到18个汉字或者36英文字符以内"),void 0;location.href="/search?q="+b}}),$("#search_text, #search_text_2").val($("#query_key").val()),$(".results-kinds a").click(function(){if(!$(this).hasClass("on")){feeds_pn=1,seckill_pn=1,cur_page_no=1,get_page_times=1,isFeedIn=!0;var a=$(this).index();$(".results-kinds a").removeClass("on"),$("#seckill_ctn .paging").hide(),$(this).addClass("on"),1==a?(show_type=1,req_type=0,doSearch(0),$(".search-choice .price-choice").show(),scroll_height=MAX_HEIGHT):2==a?(show_type=2,req_type=1,doSearch(1),$(".search-choice .price-choice").show(),scroll_height=MIN_HEIGHT):3==a&&(show_type=2,req_type=2,isFeedIn=!1,doSearch(2),$(".search-choice .price-choice").hide())}}),$(".price-choice a").click(function(){if($(this).hasClass("on"))$(this).removeClass("on"),start_price=0,end_price=1e10;else{var a=$(this).index();switch($(".price-choice a").removeClass("on"),$(this).addClass("on"),a){case 1:start_price=0,end_price=1e3;break;case 2:start_price=1e3,end_price=5e3;break;case 3:start_price=5e3,end_price=1e4;break;case 4:start_price=1e4,end_price=1e10;break;case 5:}}feeds_pn=1,seckill_pn=1,doSearch(0)}),$("#seckill_ctn .more").click(function(){$(".results-kinds a").removeClass("on"),$(".results-kinds a:eq(2)").addClass("on"),req_type=2,show_type=2,feeds_pn=1,seckill_pn=1,isFeedIn=!1,doSearch(2)}),$("#feeds_ctn .more").click(function(){$(".results-kinds a").removeClass("on"),$(".results-kinds a:eq(1)").addClass("on"),req_type=1,show_type=2,feeds_pn=1,seckill_pn=1,cur_page_no=1,get_page_times=1,isFeedIn=!0,scroll_height=MIN_HEIGHT,doSearch(1),$(".search-choice .price-choice").hide(),$("#feeds_ctn .title-ctn .title").hide(),$("#feeds_ctn .title-ctn .more").hide(),$(window).scrollTop(0)}),$(".price-choice input").focus(function(){$(".price-choice .price-input").addClass("hover")}),$("#price_confirm").click(function(){if(isNaN($("#start_price").val())||isNaN($("#end_price").val()))return alert("请输入合适的价格"),$("#start_price").val(""),$("#end_price").val(""),$(".price-choice .price-input").removeClass("hover"),void 0;var a=isEndEmpty=!1;if(""!=$("#start_price").val()){if($("#start_price").val()<0)return alert("价格不能为负"),void 0;start_price=100*$("#start_price").val()}else a=!0,start_price=0;return""!=$("#end_price").val()?end_price=100*$("#end_price").val():(isEndEmpty=!0,end_price=1e11),a&&isEndEmpty?($(".price-choice .price-input").removeClass("hover"),void 0):(start_price>end_price?alert("开始价格不能大于结束价格"):(feeds_pn=1,seckill_pn=1,doSearch(req_type),$(".price-choice a").removeClass("on"),$(".price-choice .price-input").removeClass("hover")),void 0)}),$(".feeds-ctn").delegate(".toggle","click",function(){$(this).hasClass("toggled")?($(this).parent().prev().css("height","74px"),$(this).removeClass("toggled")):($(this).parent().prev().css("height","auto"),$(this).addClass("toggled"))}),$(".feeds-ctn").delegate(".share-qqzone","click",function(){var user_id=$.cookie("od");user_id&&mm.ajaxPost("/add_user_gold",{id:user_id,job_id:"6"},function(){});var data=eval("("+$(this).parent().attr("data")+")"),s=[];return s.push("url="+encodeURIComponent(data.url||"")),s.push("desc="+encodeURIComponent(data.desc||"")),s.push("pics="+encodeURIComponent(data.pic||"")),s.push("title="+encodeURIComponent(data.title||"")),s.push("summary="+encodeURIComponent(data.text||"")),console.log(s),window.open("http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?"+s.join("&")),!1}),$(".feeds-ctn").delegate(".deserve-icon","click",function(){var a=this,b=$(this).parent().attr("id");$.cookie(b)||MM.ajaxPost("/ajax_add_worth",{id:b},function(){var c=$(a).prev().text()-0+1,d=$(a).offset();$("<div class='add-one'></div>").css({top:d.top-20,left:d.left}).appendTo("body").fadeOut(1e3,function(){$(this).remove(),$(a).prev().text(c)}),$.cookie(b,"true"),$(a).parent().addClass("clicked")})}),$(".feeds-ctn").delegate(".undeserve-icon","click",function(){var a=this,b=$(this).parent().attr("id");$.cookie(b)||MM.ajaxPost("/ajax_add_bad",{id:b},function(){var c=$(a).prev().text()-0+1,d=$(a).offset();$("<div class='add-one'></div>").css({top:d.top-20,left:d.left}).appendTo("body").fadeOut(1e3,function(){$(this).remove(),$(a).prev().text(c)}),$.cookie(b,"true"),$(a).parent().addClass("clicked")})}),$(window).scroll(function(){var a=$(document).height()-$(window).height()-$(window).scrollTop();scroll_height>=a&&isFeedIn&&!isEnd&&!isLoading&&3>get_page_times&&(isLoading=!0,$(".feeds-ctn").append('<div class="loading"><img src="/static/images/loading.gif" /></div>'),MM.ajaxPost("/do_search",{query:query_key,req_type:1,show_type:show_type,pn:cur_page_no+get_page_times,start_price:start_price,end_price:end_price},function(a){$(".feeds-ctn .loading").remove();var b=generateFeedsItems(a.data.ret_list,a.data.flush_term);$("#feeds_ctn .feeds-ctn").append($("#feedItemTmpl").tmpl(b)),isLoading=!1,get_page_times++,b.length<10&&(isEnd=!0)}))})}function initSearch(){doSearch(0)}function initTimer(a){2==a?$("#top_ctn .item").each(function(a,b){var c,d,e;if($(b).hasClass("upcoming")){c=$(".timer",b).attr("start_time_stamp");var f=MM.formatDate(1e3*c,"hhmmss");$(".starttime",b).text(f),$(".timer",b).text(f);var g=$(".desc",b).text();e=MM.formatDate(1e3*c,"yyyy-mm-dd hh:mm"),d="http://qzs.qq.com/snsapp/app/bee/widget/open.htm#content=”"+g+"“还有5分钟就要开始秒杀啦！GO！&time="+e+"&advance=5&url=http://ztmhs.maimiaotech.com/seckill?req_type=1"}else c=$(".timer",b).attr("end_time_stamp"),$(".timer",b).text(MM.formatDate(1e3*c,"hhmmss")),e=MM.formatDate(MM.getOffsetDate(new Date,1))+" 10:00",d="http://qzs.qq.com/snsapp/app/bee/widget/open.htm#content=今天的秒杀已经开始了，要知道好价格的商品可是稍纵即逝哦！&time="+e+"&advance=0&url=http://ztmhs.maimiaotech.com/seckill";$(".qqwarn a",b).attr("href",d);var h=$(b).attr("id"),i=new Date(1e3*c);mm.comm.updateTime(h,i)}):$("#seckill_ctn .item").each(function(a,b){var c,d,e;if($(b).hasClass("upcoming")){c=$(".timer",b).attr("start_time_stamp");var f=MM.formatDate(1e3*c,"hhmmss");$(".starttime",b).text(f),$(".timer",b).text(f);var g=$(".desc",b).text();e=MM.formatDate(1e3*c,"yyyy-mm-dd hh:mm"),d="http://qzs.qq.com/snsapp/app/bee/widget/open.htm#content=”"+g+"“还有5分钟就要开始秒杀啦！GO！&time="+e+"&advance=5&url=http://ztmhs.maimiaotech.com/seckill?req_type=1"}else c=$(".timer",b).attr("end_time_stamp"),$(".timer",b).text(MM.formatDate(1e3*c,"hhmmss")),e=MM.formatDate(MM.getOffsetDate(new Date,1))+" 10:00",d="http://qzs.qq.com/snsapp/app/bee/widget/open.htm#content=今天的秒杀已经开始了，要知道好价格的商品可是稍纵即逝哦！&time="+e+"&advance=0&url=http://ztmhs.maimiaotech.com/seckill";$(".qqwarn a",b).attr("href",d);var h=$(b).attr("id"),i=new Date(1e3*c);mm.comm.updateTime(h,i)})}function doSearch(a){if(0==a){$("#no_result_ctn").hide(),$("#seckill_ctn").show(),$("#feeds_ctn").show(),$("#top_ctn").show();var b=seckillEmpty=!1;mm.ajaxPost("/do_search",{query:query_key,req_type:1,show_type:show_type,pn:1,start_price:start_price,end_price:end_price},function(a){if(a.data.ret_list.length){setFeedsPaginaviBar(a.data.count);var c=generateFeedsItems(a.data.ret_list,a.data.flush_term);$("#feeds_ctn .feeds-ctn").html("");for(var d=0;d<c.length;d++)$("#feeds_ctn .feeds-ctn").append($("#feedItemTmpl").tmpl(c[d]));$("#feeds_no").text(a.data.count)}else b=!0,$("#feeds_ctn").hide(),seckillEmpty&&$("#no_result_ctn").show()}),mm.ajaxPost("/do_search",{query:query_key,req_type:2,show_type:show_type,pn:1,start_price:start_price,end_price:end_price},function(a){if(a.data.ret_list.length){$("#seckill_ctn .page-prev").hide(),1==show_type?a.data.count>SECKILL_FIRST_NO?$("#seckill_ctn .page-next").show():$("#seckill_ctn .page-next").hide():a.data.count>SECKILL_MORE_NO?$("#seckill_ctn .page-next").show():$("#seckill_ctn .page-next").hide();var c=generateSeckillItems(setHotTerm(2,a.data.ret_list,a.data.flush_term));$("#seckill_ctn .sec-kill-items").html($("#seckillItemTmpl").tmpl(c)),$("#seckill_no").text(a.data.count),initTimer()}else seckillEmpty=!0,$("#seckill_ctn").hide(),b&&$("#no_result_ctn").show()})}else 1==a?($("#no_result_ctn").hide(),$("#seckill_ctn").hide(),$("#feeds_ctn").show(),$("#top_ctn").hide(),mm.ajaxPost("/do_search",{query:query_key,req_type:1,show_type:show_type,pn:1,start_price:start_price,end_price:end_price},function(a){if(a.data.ret_list.length){setFeedsPaginaviBar(a.data.count);var b=generateFeedsItems(a.data.ret_list,a.data.flush_term);$("#feeds_ctn .feeds-ctn").html("");for(var c=0;c<b.length;c++)$("#feeds_ctn .feeds-ctn").append($("#feedItemTmpl").tmpl(b[c]));$("#feeds_no").text(a.data.count)}else $("#feeds_ctn").hide(),$("#top_ctn").show(),$("#no_result_ctn").show()})):2==a&&($("#no_result_ctn").hide(),$("#seckill_ctn").show(),$("#feeds_ctn").hide(),$("#top_ctn").hide(),mm.ajaxPost("/do_search",{query:query_key,req_type:2,show_type:show_type,pn:1,start_price:start_price,end_price:end_price},function(a){if(a.data.ret_list.length){setSeckillPaginaviBar(a.data.count);var b=generateSeckillItems(setHotTerm(2,a.data.ret_list,a.data.flush_term));$("#seckill_ctn .sec-kill-items").html($("#seckillItemTmpl").tmpl(b)),$("#seckill_no").text(a.data.count),initTimer()}else $("#seckill_ctn").hide(),$("#top_ctn").show(),$("#no_result_ctn").show()}))}function doPaging(a){1==a?mm.ajaxPost("/do_search",{query:query_key,req_type:1,show_type:show_type,pn:feeds_pn,start_price:start_price,end_price:end_price},function(a){1==feeds_pn?$("#feeds_ctn .page-prev").hide():$("#feeds_ctn .page-prev").show(),1==show_type?a.data.count>FEEDS_FIRST_NO*feeds_pn?$("#feeds_ctn .page-next").show():$("#feeds_ctn .page-next").hide():a.data.count>FEEDS_MORE_NO*feeds_pn?$("#feeds_ctn .page-next").show():$("#feeds_ctn .page-next").hide();var b=generateFeedsItems(a.data.ret_list,a.data.flush_term);$("#feeds_ctn .feeds-ctn").html("");for(var c=0;c<b.length;c++)$("#feeds_ctn .feeds-ctn").append($("#feedItemTmpl").tmpl(b[c]))}):2==a&&mm.ajaxPost("/do_search",{query:query_key,req_type:2,show_type:show_type,pn:seckill_pn,start_price:start_price,end_price:end_price},function(a){1==seckill_pn?$("#seckill_ctn .page-prev").hide():$("#seckill_ctn .page-prev").show(),1==show_type?a.data.count>SECKILL_FIRST_NO*seckill_pn?$("#seckill_ctn .page-next").show():$("#seckill_ctn .page-next").hide():a.data.count>SECKILL_MORE_NO*seckill_pn?$("#seckill_ctn .page-next").show():$("#seckill_ctn .page-next").hide();var b=generateSeckillItems(setHotTerm(2,a.data.ret_list,a.data.flush_term));$("#seckill_ctn .sec-kill-items").html($("#seckillItemTmpl").tmpl(b)),initTimer()})}function setFeedsPaginaviBar(a){var b=a%30,c=Math.floor(a/30);$("#feeds_ctn .paging").myPagination({pageCount:b?c+1:c,pageNumber:10,cssStyle:"search",ajax:{on:!1,onClick:function(a){var b=a;b=1==a?1:3*(a-1)+1,cur_page_no=b,get_page_times=1,mm.ajaxPost("/do_search",{query:query_key,req_type:1,show_type:show_type,pn:b,start_price:start_price,end_price:end_price},function(a){if(a.data.ret_list.length){var b=generateFeedsItems(a.data.ret_list,a.data.flush_term);$("#feeds_ctn .feeds-ctn").html("");for(var c=0;c<b.length;c++)$("#feeds_ctn .feeds-ctn").append($("#feedItemTmpl").tmpl(b[c]));$("#feeds_no").text(a.data.count),$("#seckill_ctn:visible")[0]?$(window).scrollTop(580):$(window).scrollTop(120)}else $("#feeds_ctn").hide()})}}})}function setSeckillPaginaviBar(a){var b=a%40,c=Math.floor(a/40);$("#seckill_ctn .paging").myPagination({pageCount:b?c+1:c,pageNumber:10,cssStyle:"search",ajax:{on:!1,onClick:function(a){mm.ajaxPost("/do_search",{query:query_key,req_type:2,show_type:show_type,pn:a,start_price:start_price,end_price:end_price},function(a){if(a.data.ret_list.length){var b=generateSeckillItems(setHotTerm(2,a.data.ret_list,a.data.flush_term));$("#seckill_ctn .sec-kill-items").html($("#seckillItemTmpl").tmpl(b)),$("#seckill_no").text(a.data.count),initTimer(),$(window).scrollTop(120)}else $("#seckill_ctn").hide()})}}})}function generateSeckillItems(a){for(var b=0,c=a.length;c>b;b++)a[b].title=$.trim(a[b].title),a[b].cur_price=-1==a[b].cur_price?-1:a[b].cur_price/100,a[b].ori_price=-1==a[b].ori_price?-1:a[b].ori_price/100,a[b].discount=-1==a[b].discount?-1:a[b].discount/10;return a}function setHotTerm(a,b,c){var d;if(1==a)for(var e=0,f=b.length;f>e;e++)for(var g=0,h=c.length;h>g;g++)d=new RegExp(c[g],"ig"),b[e].desc=b[e].desc.replace(d,'<span class="flush">'+c[g]+"</span>"),b[e].title=b[e].title.replace(d,'<span class="flush">'+c[g]+"</span>");else if(2==a)for(var e=0,f=b.length;f>e;e++)for(var g=0,h=c.length;h>g;g++)d=new RegExp(c[g],"ig"),b[e].title=b[e].title.replace(d,'<span class="flush">'+c[g]+"</span>");return b}function generateFeedsItems(a,b){for(var c=0,d=a.length;d>c;c++)a[c].cat=a[c].cat[0],a[c].our_cat=cat_dict[a[c].our_cat],a[c].descData=JSON.stringify({url:"http://ztmhs.maimiaotech.com/redirect/?"+a[c].img_link_id,pic:a[c].img.indexOf("http://")<0?"http://ztmhs.maimiaotech.com"+a[c].img:a[c].img,title:a[c].title,text:a[c].desc[0],desc:"全网性价比商品哪里找？秒杀宝贝时时有？还有金币换现金？真划算帮你实现，传送门：http://ztmhs.maimiaotech.com"}),a[c].title=$.trim(setHotTitle(a[c].title,a[c].flush)),a[c].title.length>60&&(a[c].title=a[c].title.substr(0,60)+"..."),a[c].desc=makeProductLink(a[c].desc,a[c].desc_link);return setHotTerm(1,a,b)}function setHotTitle(a,b){for(var c=0,d=b.length;d>c;c++){var e=$.trim(b[c]);a=a.replace(e,"<strong>"+e+"</strong>")}return a}function makeProductLink(a,b){for(var c="",d=0,e=a.length;e>d;d++)c=c+"<p>"+a[d]+"</p>";for(var d=0,e=b.length;e>d;d++)c=c.replace(b[d][0],'<a target="_blank" href="/redirect/?'+b[d][1]+'">'+b[d][0]+"</a>");return c}var mm=require("./base");require("myPagination");var pub={},cat_dict={0:"全部",1:"白菜价",2:"强烈值得买",3:"促销活动"},req_type=0,show_type=1,start_price=0,end_price=1e11,feeds_pn=1,seckill_pn=1,query_key=$("#query_key").val(),sources=["易迅","苏宁","天猫","亚马逊","当当","国美","1号店","QQ商城","好乐买","聚美优品","我买网"],source_index=0,FEEDS_FIRST_NO=10,FEEDS_MORE_NO=10,SECKILL_FIRST_NO=4,SECKILL_MORE_NO=40,get_page_times=1,isLoading=!1,isEnd=!1,isFeedIn=!0,cur_page_no=1,MAX_HEIGHT=200,MIN_HEIGHT=200,scroll_height=MAX_HEIGHT;pub.init=function(){$("#default_value").hide(),initSearch(),initEvent()},module.exports=pub});